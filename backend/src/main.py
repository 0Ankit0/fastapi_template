from contextlib import asynccontextmanager
import os
from fastapi import FastAPI
from fastapi.responses import RedirectResponse
from fastapi.middleware.cors import CORSMiddleware
from fastapi.middleware.trustedhost import TrustedHostMiddleware
from fastapi.staticfiles import StaticFiles
from slowapi import Limiter
from slowapi.util import get_remote_address
from slowapi.errors import RateLimitExceeded
from src.apps.core.config import settings
from src.apps.core.handler import rate_limit_exceeded_handler
from src.apps.core.middleware import SecurityHeadersMiddleware, IPAccessControlMiddleware
from src.apps.iam.api import api_router
from src.apps.finance.api import finance_router
from src.apps.multitenancy.api import multitenancy_router
from src.db.session import engine, init_db
from src.apps.iam.casbin_enforcer import CasbinEnforcer
from src.apps.websocket.api import ws_router
from src.apps.websocket.manager import manager as ws_manager
from src.apps.core.cache import RedisCache
from src.apps.notification.api import notification_router

# Rate limiter
limiter = Limiter(key_func=get_remote_address, default_limits=["100/minute"])

@asynccontextmanager
async def lifespan(app: FastAPI):
    """Initialize DB tables, Casbin enforcer, Redis cache, and WebSocket manager on startup."""
    await init_db()

    enforcer = await CasbinEnforcer.get_enforcer(engine)
    app.state.casbin_enforcer = enforcer

    # Initialize Redis cache + WebSocket pub/sub in production
    if not settings.DEBUG:
        if settings.REDIS_URL:
            await RedisCache.get_client()
            await ws_manager.setup_redis(settings.REDIS_URL)

    app.state.ws_manager = ws_manager

    yield

    # Cleanup on shutdown
    await ws_manager.teardown()
    await RedisCache.close()

app = FastAPI(
    lifespan=lifespan,
    title="fastapi_template",
    description="A template for FastAPI applications",
    version="0.1.0",
    swagger_ui_parameters={
        "syntaxHighlight.theme": "monokai",  # Syntax highlighting theme
        "deepLinking": True,  # Enable deep linking to operations
        "displayOperationId": True,  # Show operation IDs
        "filter": True,  # Enable search/filter bar
        "showExtensions": True,  # Show vendor extensions
        "showCommonExtensions": True,
        "persistAuthorization": True,  # Remember authorization between reloads
        "displayRequestDuration": True,  # Show request duration
        "docExpansion": "list",  # Default expansion: "list", "full", or "none"
        "defaultModelsExpandDepth": 1,  # How deep to expand models
        "defaultModelExpandDepth": 1,
    }
)

# Add rate limiter to app state and register exception handler
app.state.limiter = limiter
app.add_exception_handler(RateLimitExceeded, rate_limit_exceeded_handler) 

# Security headers middleware
app.add_middleware(SecurityHeadersMiddleware)

# IP access control middleware
app.add_middleware(IPAccessControlMiddleware)

# CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=[str(origin) for origin in settings.BACKEND_CORS_ORIGINS],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Trusted host middleware (prevent host header attacks)
if not settings.DEBUG:
    app.add_middleware(
        TrustedHostMiddleware,
        allowed_hosts=["localhost", "127.0.0.1", settings.SERVER_HOST.replace("http://", "").replace("https://", "")]
    )

app.include_router(api_router, prefix=settings.API_V1_STR)
app.include_router(finance_router, prefix=settings.API_V1_STR)
app.include_router(multitenancy_router, prefix=settings.API_V1_STR)
app.include_router(ws_router, prefix=settings.API_V1_STR)
app.include_router(notification_router, prefix=settings.API_V1_STR)

# Serve uploaded media files (avatars, etc.)
os.makedirs(settings.MEDIA_DIR, exist_ok=True)
app.mount(settings.MEDIA_URL, StaticFiles(directory=settings.MEDIA_DIR), name="media")

@app.get("/", include_in_schema=False)
async def read_root() -> RedirectResponse:
    """Redirect root to the interactive API documentation."""
    return RedirectResponse(url="/docs")